<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ship Database Schema Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fill-pct-bar { height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; }
        .fill-pct-bar-inner { height: 100%; border-radius: 2px; }
        .schema-table { transition: all 0.2s ease; }
        .schema-table:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .field-item { cursor: pointer; transition: all 0.15s ease; position: relative; }
        .field-item:hover { background-color: rgb(243 244 246); }
        .field-item.has-mapping:hover { background-color: rgb(219 234 254); }
        .source-column-highlight { animation: pulse-highlight 1.5s ease-in-out infinite; }
        @keyframes pulse-highlight { 0%, 100% { background-color: rgb(254 249 195); } 50% { background-color: rgb(253 224 71); } }
        .field-item { cursor: pointer; }
        .field-item.has-example:hover { background-color: rgb(219 234 254); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const FIELD_EXAMPLES = {
            // Vessels (Core) table
            'id': '12345',
            'imo_number': '9134270',
            'mmsi': '412345678',
            'call_sign': 'BQKV',
            'national_registration_number': 'PE-01234-CM',
            'external_marking': 'INKA 201',
            'vessel_name': 'HAI FENG 823',
            'vessel_name_local': '海丰823',
            'previous_name': 'LIAN RUN 22',
            'flag': 'China',
            'port_of_registry': 'Zhoushan',
            'owner_name': 'Zhejiang Ocean Family Co Ltd',
            'owner_address': '88 Haitian Road, Zhoushan, Zhejiang',
            'operator_name': 'Pingtan Marine Enterprise',
            'operator_address': '18 Pingtan Road, Fuzhou, Fujian',
            'gear_type': 'Trawlers - Midwater',
            'width_meters': '13.5',
            'length_meters': '58.2',
            'gross_tonnage': '1,245',
            'number_of_crew': '28',
            'ship_status': 'Active',
            'ship_status_effective_date': '2024-01-15',
            'iuu_combined_list_link': 'https://iuu-vessels.org/vessel/12345',
            'iuu_combined_list': 'true',
            'scraper_notes': 'Vessel data updated from WCPFC registry 2024-03',
            'sea_shepherd_arrest_info': 'Detained in Liberia Aug 2019 for illegal transshipment',

            // Authorizing Bodies (Lookup) table
            'code': 'WCPFC',
            'full_name': 'Western and Central Pacific Fisheries Commission',
            'body_type': 'RFMO',
            'website_url': 'https://www.wcpfc.int/',
            'description': 'Primary source for vessel identity verification',

            // Vessel Authorizations (Junction) table
            'vessel_id': '12345 (FK to vessels.id)',
            'authorizing_body_id': '3 (FK to authorizing_bodies.id)',
            'authorization_number': 'VR-2024-CHN-0892',
            'authorization_start_date': '2024-01-01',
            'authorization_end_date': '2024-12-31',
            'authorization_link': 'https://wcpfc.int/vessel/VR-2024-CHN-0892',
            'is_registered': 'true',
            'source_info_last_updated': '2024-03-15',
            'source_info_acquired': '2024-02-01',

            // Identity Sources (Lookup) table
            'identity_source_id': '2 (FK to identity_sources.id)',

            // Vessel Identity Confirmations (Junction) table
            'is_confirmed': 'true',
            'confirmation_date': '2024-01-20',
            'source_data': '{"gfw_vessel_id": "CHN-FV-8823", "confidence_score": 0.95, "last_ais_position": {"lat": -12.45, "lon": -77.12}, "matched_fields": ["imo", "mmsi", "call_sign"]}',
            'notes': 'Identity confirmed via AIS correlation',

            // IUU Organizations (Lookup) table
            'organization_id': '5 (FK to iuu_organizations.id)',

            // Vessel IUU Listings (Junction) table
            'listing_date': '2022-05-20',
            'listing_reason': 'Fishing without valid license in ICCAT waters; failure to report catch',
            'delisting_date': '2023-08-15',
            'is_currently_listed': 'false',

            // Countries (Lookup) table
            'name': 'Peru',
            'region': 'South America',

            // Vessel Country Registrations (Junction) table
            'country_id': '8 (FK to countries.id)',
            'fishing_license_number': 'PE-2024-CM-0456',
            'license_valid_from': '2024-01-01',
            'license_valid_until': '2024-12-31',
            'fishing_permit_status': 'VIGENTE',
            'taxpayer_id': 'RUC-20123456789',
            'additional_data': '{"port_assignments": ["Callao", "Chimbote"], "vessel_category": "Industrial", "authorized_species": ["Anchoveta", "Sardine"], "quota_mt": 2500}',

            // FMFO Countries (Lookup) table
            'fmfo_country_id': '4 (FK to fmfo_countries.id)',

            // Vessel FMFO Listings (Junction) table
            'is_listed': 'true',
            'listing_year': '2024',

            // Friend of the Sea Certifications table
            'registration_number': 'FOS-2024-0123',
            'certified_company': 'Ocean Fresh Seafood Co.',
            'fao_fishing_area': 'Area 87 - Southeast Pacific',
            'targeted_species': 'Anchoveta (Engraulis ringens)',
            'certificate_status': 'Valid',

            // Vessel Name History table
            'name_from_date': '2015-06-01',
            'name_to_date': '2019-03-15',
            'source': 'IHS Markit historical records',

            // Vessel Arrests table
            'arrest_date': '2019-08-22',
            'arresting_authority': 'Liberia Coast Guard',
            'arrest_location': 'Monrovia, Liberia (6.3°N, 10.8°W)',
            'arrest_reason': 'Illegal transshipment at sea; fishing in restricted zone'
        };
        const NEW_SCHEMA = {
            vessels: { name: 'vessels', displayName: 'Vessels (Core)', type: 'core', description: 'Central table with 191K vessel records', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'imo_number', type: 'VARCHAR(20)', sources: ['IMO Number'] },
                { name: 'mmsi', type: 'VARCHAR(15)', sources: ['MMSI'] }, { name: 'call_sign', type: 'VARCHAR(20)', sources: ['Call Sign'] },
                { name: 'national_registration_number', type: 'VARCHAR(50)', sources: ['National Registration Number'] },
                { name: 'external_marking', type: 'VARCHAR(100)', sources: ['External Marking'] },
                { name: 'vessel_name', type: 'VARCHAR(255)', sources: ['Vessel Name'] },
                { name: 'vessel_name_local', type: 'VARCHAR(255)', sources: ['Vessel Name in local language'] },
                { name: 'previous_name', type: 'TEXT', sources: ['Previous Name'] }, { name: 'flag', type: 'VARCHAR(100)', sources: ['Flag'] },
                { name: 'port_of_registry', type: 'VARCHAR(255)', sources: ['Port of Registry'] },
                { name: 'owner_name', type: 'VARCHAR(255)', sources: ['Owner Name'] }, { name: 'owner_address', type: 'TEXT', sources: ['Owner Address'] },
                { name: 'operator_name', type: 'VARCHAR(255)', sources: ['Operator Name'] }, { name: 'operator_address', type: 'TEXT', sources: ['Operator Address'] },
                { name: 'gear_type', type: 'VARCHAR(255)', sources: ['Gear'] }, { name: 'width_meters', type: 'DECIMAL(8,2)', sources: ['Width (m)'] },
                { name: 'length_meters', type: 'DECIMAL(8,2)', sources: ['Length (m)'] }, { name: 'gross_tonnage', type: 'DECIMAL(10,2)', sources: ['Gross Tonnage'] },
                { name: 'number_of_crew', type: 'INTEGER', sources: ['Number of Crew'] }, { name: 'ship_status', type: 'VARCHAR(100)', sources: ['Ship Status'] },
                { name: 'ship_status_effective_date', type: 'DATE', sources: ['Ship Status Effective Date'] },
                { name: 'iuu_combined_list_link', type: 'TEXT', sources: ['IUU Combined List Vessel Link'] },
                { name: 'iuu_combined_list', type: 'BOOLEAN', sources: ['IUU Combined List'] },
                { name: 'scraper_notes', type: 'TEXT', sources: ['Scraper Notes'] }, { name: 'sea_shepherd_arrest_info', type: 'TEXT', sources: ['Sea Shepherd Arrest Info'] }
            ]},
            authorizing_bodies: { name: 'authorizing_bodies', displayName: 'Authorizing Bodies (Lookup)', type: 'lookup', description: '14 records: RFMOs + EU + FAO', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'code', type: 'VARCHAR(20)', sources: [] },
                { name: 'full_name', type: 'VARCHAR(255)', sources: [] }, { name: 'body_type', type: 'VARCHAR(50)', sources: [] }, { name: 'website_url', type: 'TEXT', sources: [] }
            ]},
            vessel_authorizations: { name: 'vessel_authorizations', displayName: 'Vessel Authorizations (Junction)', type: 'junction', description: 'Replaces 68 RFMO/EU/FAO columns', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'vessel_id', type: 'INTEGER (FK)', sources: [] }, { name: 'authorizing_body_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'authorization_number', type: 'VARCHAR(100)', sources: ['Authorization Number for SEAFO', 'Authorization Number for NEAFC', 'Authorization Number for IATTC', 'Authorization Number for NAFO', 'Authorization Number for IOTC', 'Authorization Number for WCPFC', 'Authorization Number for NPFC', 'Authorization Number for SPRFMO', 'Authorization Number for ICCAT', 'Authorization Number for CCAMLR', 'Authorization Number for GFCM'] },
                { name: 'authorization_start_date', type: 'DATE', sources: ['Start dates for 11 RFMOs'] },
                { name: 'authorization_end_date', type: 'DATE', sources: ['End dates for 11 RFMOs'] },
                { name: 'authorization_link', type: 'TEXT', sources: ['Links for 13 sources including FAO'] },
                { name: 'is_registered', type: 'BOOLEAN', sources: ['Registered with EU'] },
                { name: 'source_info_last_updated', type: 'DATE', sources: ['Update dates (8 cols)'] },
                { name: 'source_info_acquired', type: 'DATE', sources: ['Acquired dates (7 cols)'] }
            ]},
            identity_sources: { name: 'identity_sources', displayName: 'Identity Sources (Lookup)', type: 'lookup', description: '4 records: MagicPort, GFW, IHS', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'code', type: 'VARCHAR(20)', sources: [] },
                { name: 'full_name', type: 'VARCHAR(255)', sources: [] }, { name: 'description', type: 'TEXT', sources: [] }
            ]},
            vessel_identity_confirmations: { name: 'vessel_identity_confirmations', displayName: 'Vessel Identity Confirmations (Junction)', type: 'junction', description: 'Tracks identity verification sources', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'vessel_id', type: 'INTEGER (FK)', sources: [] }, { name: 'identity_source_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'is_confirmed', type: 'BOOLEAN', sources: ['Listed in MagicPort', 'Identity Confirmed by GFW', 'From GFW Data', 'IHS Markit Data'] },
                { name: 'confirmation_date', type: 'DATE', sources: [] }, { name: 'source_data', type: 'JSONB', sources: [] }, { name: 'notes', type: 'TEXT', sources: [] }
            ]},
            iuu_organizations: { name: 'iuu_organizations', displayName: 'IUU Organizations (Lookup)', type: 'lookup', description: '13 organizations maintaining IUU lists', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'code', type: 'VARCHAR(20)', sources: [] }, { name: 'full_name', type: 'VARCHAR(255)', sources: [] }
            ]},
            vessel_iuu_listings: { name: 'vessel_iuu_listings', displayName: 'Vessel IUU Listings (Junction)', type: 'junction', description: 'Replaces 24 IUU columns', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'vessel_id', type: 'INTEGER (FK)', sources: [] }, { name: 'organization_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'listing_date', type: 'DATE', sources: ['IUU Listing Date for 12 orgs'] },
                { name: 'listing_reason', type: 'TEXT', sources: ['IUU Listing Reason for 12 orgs'] },
                { name: 'delisting_date', type: 'DATE', sources: [] }, { name: 'is_currently_listed', type: 'BOOLEAN', sources: [] }
            ]},
            countries: { name: 'countries', displayName: 'Countries (Lookup)', type: 'lookup', description: '15 countries with registries', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'code', type: 'VARCHAR(10)', sources: [] },
                { name: 'name', type: 'VARCHAR(255)', sources: [] }, { name: 'region', type: 'VARCHAR(100)', sources: [] }
            ]},
            vessel_country_registrations: { name: 'vessel_country_registrations', displayName: 'Vessel Country Registrations (Junction)', type: 'junction', description: 'Replaces ~50 country columns', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'vessel_id', type: 'INTEGER (FK)', sources: [] }, { name: 'country_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'is_registered', type: 'BOOLEAN', sources: [] },
                { name: 'fishing_license_number', type: 'VARCHAR(100)', sources: ['PERU_License Number', 'THAI_License Number', 'INDONESIA_License'] },
                { name: 'license_valid_from', type: 'DATE', sources: [] },
                { name: 'license_valid_until', type: 'DATE', sources: ['PERU_Permit Expiration', 'THAI_Cert Expiration'] },
                { name: 'fishing_permit_status', type: 'VARCHAR(100)', sources: ['PERU_Permit Status', 'THAI_Permit Availability'] },
                { name: 'taxpayer_id', type: 'VARCHAR(100)', sources: ['PERU_Taxpayer ID'] }, { name: 'additional_data', type: 'JSONB', sources: [] }
            ]},
            fmfo_countries: { name: 'fmfo_countries', displayName: 'FMFO Countries (Lookup)', type: 'lookup', description: '11 FMFO monitoring countries', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'code', type: 'VARCHAR(10)', sources: [] }, { name: 'name', type: 'VARCHAR(255)', sources: [] }
            ]},
            vessel_fmfo_listings: { name: 'vessel_fmfo_listings', displayName: 'Vessel FMFO Listings (Junction)', type: 'junction', description: 'Replaces 11 FMFO boolean columns', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'vessel_id', type: 'INTEGER (FK)', sources: [] }, { name: 'fmfo_country_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'is_listed', type: 'BOOLEAN', sources: ['Peru FMFO', 'India FMFO', 'Ecuador FMFO', 'Thailand FMFO', '+7 more'] },
                { name: 'listing_year', type: 'INTEGER', sources: [] }, { name: 'notes', type: 'TEXT', sources: [] }
            ]},
            friend_of_sea_certifications: { name: 'friend_of_sea_certifications', displayName: 'Friend of the Sea Certs', type: 'supporting', description: 'FOS certification data', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'vessel_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'registration_number', type: 'VARCHAR(100)', sources: ['Friend of the Sea Registration Number'] },
                { name: 'certified_company', type: 'VARCHAR(255)', sources: ['Company authorized to sell FOS products'] },
                { name: 'fao_fishing_area', type: 'VARCHAR(255)', sources: ['FAO fishing area per FOS'] },
                { name: 'targeted_species', type: 'TEXT', sources: ['Targeted species per FOS'] },
                { name: 'certificate_status', type: 'VARCHAR(50)', sources: ['FOS Certificate Status'] }
            ]},
            vessel_name_history: { name: 'vessel_name_history', displayName: 'Vessel Name History', type: 'supporting', description: 'Historical names for compliance', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'vessel_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'previous_name', type: 'VARCHAR(255)', sources: ['Previous Name'] },
                { name: 'name_from_date', type: 'DATE', sources: [] }, { name: 'name_to_date', type: 'DATE', sources: [] }, { name: 'source', type: 'VARCHAR(255)', sources: [] }
            ]},
            vessel_arrests: { name: 'vessel_arrests', displayName: 'Vessel Arrests', type: 'supporting', description: 'Enforcement arrest records', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'vessel_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'arrest_date', type: 'DATE', sources: [] }, { name: 'arresting_authority', type: 'VARCHAR(255)', sources: [] },
                { name: 'arrest_location', type: 'VARCHAR(255)', sources: [] }, { name: 'arrest_reason', type: 'TEXT', sources: ['Sea Shepherd Arrest Info'] }
            ]}
        };

        function App() {
            const [loading, setLoading] = useState(true);
            const [loadingStatus, setLoadingStatus] = useState('Loading...');
            const [loadError, setLoadError] = useState(null);
            const [allColumns, setAllColumns] = useState([]);
            const [columnStats, setColumnStats] = useState({});
            const [totalRows, setTotalRows] = useState(0);
            const [searchFilter, setSearchFilter] = useState('');
            const [selectedNewField, setSelectedNewField] = useState(null);
            const [selectedNewTable, setSelectedNewTable] = useState(null);
            const [highlightedSourceColumns, setHighlightedSourceColumns] = useState([]);
            const [showFieldMappingModal, setShowFieldMappingModal] = useState(false);
            const [showExampleModal, setShowExampleModal] = useState(false);

            useEffect(() => { loadCSVData(); }, []);

            const loadCSVData = async () => {
                setLoading(true);
                try {
                    const sampleResults = await new Promise((resolve, reject) => {
                        Papa.parse('sample_data.csv', { download: true, header: true, skipEmptyLines: true, complete: resolve, error: reject });
                    });
                    const columns = (sampleResults.meta.fields || []).filter(c => c && c.trim() && c !== 'Unnamed: 0');
                    setAllColumns(columns);
                    setLoadingStatus('Calculating statistics...');
                    const stats = {}; let rowCount = 0;
                    columns.forEach(col => { stats[col] = { nonEmptyCount: 0, uniqueValues: new Set() }; });
                    await new Promise((resolve, reject) => {
                        Papa.parse('full_data.csv', { download: true, header: true, skipEmptyLines: true,
                            step: (row) => { rowCount++; columns.forEach(col => { const val = row.data[col]; if (val && val.trim()) { stats[col].nonEmptyCount++; if (stats[col].uniqueValues.size < 100) stats[col].uniqueValues.add(val.trim()); }}); if (rowCount % 5000 === 0) setLoadingStatus(`Row ${rowCount.toLocaleString()}...`); },
                            complete: resolve, error: reject });
                    });
                    const finalStats = {};
                    columns.forEach(col => { finalStats[col] = { fillPct: rowCount > 0 ? (stats[col].nonEmptyCount / rowCount * 100).toFixed(1) : 0, nonEmptyCount: stats[col].nonEmptyCount, uniqueValues: Array.from(stats[col].uniqueValues).sort() }; });
                    setColumnStats(finalStats); setTotalRows(rowCount); setLoading(false);
                } catch (error) { console.error(error); setLoadError('Failed to load data.'); setLoading(false); }
            };

            const getFillBarColor = (pct) => { const p = parseFloat(pct); if (p >= 80) return 'bg-green-500'; if (p >= 50) return 'bg-yellow-500'; if (p >= 20) return 'bg-orange-500'; return 'bg-red-500'; };
            const getTypeColor = (type) => { switch(type) { case 'core': return 'border-blue-500'; case 'lookup': return 'border-green-500'; case 'junction': return 'border-purple-500'; case 'supporting': return 'border-orange-500'; default: return 'border-gray-500'; } };
            const getTypeBadgeColor = (type) => { switch(type) { case 'core': return 'bg-blue-100 text-blue-800'; case 'lookup': return 'bg-green-100 text-green-800'; case 'junction': return 'bg-purple-100 text-purple-800'; case 'supporting': return 'bg-orange-100 text-orange-800'; default: return 'bg-gray-100 text-gray-800'; } };
            const handleFieldClick = (tableName, field) => {
                setSelectedNewTable(tableName);
                setSelectedNewField(field);
                if (field.sources?.length > 0) {
                    setHighlightedSourceColumns(field.sources);
                    setShowFieldMappingModal(true);
                } else {
                    setShowExampleModal(true);
                }
            };
            const getFilteredColumns = (columns) => { if (!searchFilter.trim()) return columns; const f = searchFilter.toLowerCase(); return columns.filter(col => col.toLowerCase().includes(f)); };
            const getExampleValue = (fieldName) => FIELD_EXAMPLES[fieldName] || null;

            if (loading) return <div className="min-h-screen bg-gray-100 flex items-center justify-center"><div className="text-center"><div className="loading-spinner mx-auto mb-4"></div><p className="text-gray-600">{loadingStatus}</p></div></div>;
            if (loadError) return <div className="min-h-screen bg-gray-100 flex items-center justify-center"><div className="bg-white rounded-lg shadow-lg p-8 max-w-md text-center"><h2 className="text-xl font-bold mb-2">Error</h2><p className="text-gray-600 mb-4">{loadError}</p><button onClick={loadCSVData} className="px-4 py-2 bg-blue-600 text-white rounded-lg">Retry</button></div></div>;

            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-white shadow-sm border-b sticky top-0 z-40"><div className="max-w-full mx-auto px-4 py-4"><h1 className="text-2xl font-bold text-gray-900">Ship Database Schema Designer</h1><p className="text-sm text-gray-500 mt-1">{allColumns.length} columns | {totalRows.toLocaleString()} rows</p></div></header>
                    <div className="max-w-full mx-auto px-4 py-6">
                        <div className="bg-white rounded-lg shadow p-6 mb-6">
                            <h2 className="text-xl font-bold mb-4">Schema Transformation Summary</h2>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="text-center p-4 bg-red-50 rounded-lg border border-red-200"><div className="text-3xl font-bold text-red-600">{allColumns.length}</div><div className="text-sm text-red-700">Current Columns</div></div>
                                <div className="text-center p-4 bg-green-50 rounded-lg border border-green-200"><div className="text-3xl font-bold text-green-600">{Object.keys(NEW_SCHEMA).length}</div><div className="text-sm text-green-700">New Tables</div></div>
                                <div className="text-center p-4 bg-blue-50 rounded-lg border border-blue-200"><div className="text-3xl font-bold text-blue-600">{Object.values(NEW_SCHEMA).reduce((sum, t) => sum + t.fields.length, 0)}</div><div className="text-sm text-blue-700">New Fields</div></div>
                                <div className="text-center p-4 bg-purple-50 rounded-lg border border-purple-200"><div className="text-3xl font-bold text-purple-600">51%</div><div className="text-sm text-purple-700">Reduction</div></div>
                            </div>
                        </div>
                        <div className="bg-white rounded-lg shadow p-4 mb-6">
                            <h3 className="font-semibold mb-3">Table Types</h3>
                            <div className="flex flex-wrap gap-4">
                                <div className="flex items-center gap-2"><div className="w-4 h-4 rounded border-2 border-blue-500 bg-blue-50"></div><span className="text-sm">Core</span></div>
                                <div className="flex items-center gap-2"><div className="w-4 h-4 rounded border-2 border-green-500 bg-green-50"></div><span className="text-sm">Lookup</span></div>
                                <div className="flex items-center gap-2"><div className="w-4 h-4 rounded border-2 border-purple-500 bg-purple-50"></div><span className="text-sm">Junction</span></div>
                                <div className="flex items-center gap-2"><div className="w-4 h-4 rounded border-2 border-orange-500 bg-orange-50"></div><span className="text-sm">Supporting</span></div>
                                <div className="flex items-center gap-2 ml-8"><div className="w-4 h-4 rounded bg-blue-100"></div><span className="text-sm">Click any field to see example value</span></div>
                            </div>
                        </div>
                        <div className="mb-8">
                            <h2 className="text-xl font-bold mb-4"><span className="text-green-600">NEW</span> Relational Schema (14 Tables)</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                {Object.entries(NEW_SCHEMA).map(([tableName, table]) => (
                                    <div key={tableName} className={`schema-table bg-white rounded-lg shadow border-l-4 ${getTypeColor(table.type)}`}>
                                        <div className="p-4 border-b bg-gray-50"><div className="flex items-center justify-between"><h3 className="font-bold text-gray-900">{table.name}</h3><span className={`text-xs px-2 py-1 rounded ${getTypeBadgeColor(table.type)}`}>{table.type}</span></div><p className="text-xs text-gray-500 mt-1">{table.description}</p></div>
                                        <div className="p-2 max-h-[300px] overflow-y-auto">
                                            {table.fields.map((field, idx) => { const hasMapping = field.sources?.length > 0; const example = getExampleValue(field.name);
                                                return (<div key={idx} onClick={() => handleFieldClick(tableName, field)} className={`field-item p-2 rounded text-sm border mb-1 ${hasMapping ? 'bg-blue-50 border-blue-200 has-mapping has-example' : example ? 'bg-gray-50 border-gray-200 has-example' : 'bg-gray-50 border-gray-200'}`}>
                                                    <div className="flex justify-between items-start"><span className="font-medium text-gray-800">{field.name}</span><span className="text-xs text-gray-500 ml-2">{field.type}</span></div>
                                                    {hasMapping && <div className="text-xs text-blue-600 mt-1">Replaces {field.sources.length} column{field.sources.length > 1 ? 's' : ''}</div>}
                                                    {!hasMapping && example && <div className="text-xs text-gray-500 mt-1">Click for example</div>}
                                                </div>); })}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <details className="bg-white rounded-lg shadow mb-6">
                            <summary className="p-4 cursor-pointer font-bold text-lg flex items-center justify-between"><span><span className="text-red-600">CURRENT</span> Flat Structure ({allColumns.length} Columns)</span><span className="text-sm font-normal text-gray-500">Click to expand</span></summary>
                            <div className="p-4 border-t">
                                <input type="text" placeholder="Search columns..." value={searchFilter} onChange={(e) => setSearchFilter(e.target.value)} className="w-full max-w-md px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 mb-4" />
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 max-h-[500px] overflow-y-auto">
                                    {getFilteredColumns(allColumns).map(col => { const isHighlighted = highlightedSourceColumns.includes(col); const fillPct = columnStats[col]?.fillPct || 0;
                                        return (<div key={col} className={`p-2 rounded border text-xs ${isHighlighted ? 'source-column-highlight border-yellow-400' : 'bg-white border-gray-200'}`} title={`${col}\n${fillPct}%`}>
                                            <div className="truncate font-medium">{col}</div>
                                            <div className="flex items-center gap-1 mt-1"><div className="fill-pct-bar flex-1"><div className={`fill-pct-bar-inner ${getFillBarColor(fillPct)}`} style={{ width: `${fillPct}%` }} /></div><span className="text-gray-500">{fillPct}%</span></div>
                                        </div>); })}
                                </div>
                            </div>
                        </details>
                    </div>
                    {showFieldMappingModal && selectedNewField && (
                        <div className="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg shadow-xl p-6 w-[700px] max-w-full mx-4 max-h-[85vh] overflow-hidden flex flex-col">
                                <div className="flex justify-between items-start mb-4">
                                    <div><h3 className="text-lg font-bold">Field Mapping</h3><p className="text-sm text-gray-500 mt-1"><span className="font-mono bg-blue-100 px-2 py-1 rounded">{selectedNewField.name}</span> in <span className="font-semibold">{NEW_SCHEMA[selectedNewTable]?.displayName}</span></p></div>
                                    <button onClick={() => { setShowFieldMappingModal(false); setHighlightedSourceColumns([]); }} className="text-gray-500 hover:text-gray-700"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg></button>
                                </div>
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                    <span className="font-semibold text-blue-800">Replaces {selectedNewField.sources.length} column{selectedNewField.sources.length > 1 ? 's' : ''}</span>
                                    <p className="text-sm text-blue-700 mt-2">Instead of separate columns, this field stores all values with organization identified via FK.</p>
                                </div>
                                {getExampleValue(selectedNewField.name) && (
                                    <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                        <span className="font-semibold text-green-800">Example Value:</span>
                                        <pre className="mt-2 text-sm text-green-700 whitespace-pre-wrap break-all font-mono bg-green-100 p-2 rounded">{getExampleValue(selectedNewField.name)}</pre>
                                    </div>
                                )}
                                <div className="flex-1 overflow-y-auto"><h4 className="font-semibold mb-2 text-gray-700">Source Columns:</h4><div className="space-y-2">
                                    {selectedNewField.sources.map((source, idx) => { const stats = columnStats[source]; return (
                                        <div key={idx} className="p-3 rounded border bg-gray-50 border-gray-200"><span className="text-sm font-medium">{source}</span>
                                            {stats && <div className="mt-2 flex items-center gap-2"><div className="fill-pct-bar flex-1 max-w-[200px]"><div className={`fill-pct-bar-inner ${getFillBarColor(stats.fillPct)}`} style={{ width: `${stats.fillPct}%` }} /></div><span className="text-xs text-gray-500">{stats.fillPct}% ({stats.nonEmptyCount?.toLocaleString() || 0})</span></div>}
                                        </div>); })}
                                </div></div>
                                <div className="mt-4 pt-4 border-t flex justify-end"><button onClick={() => { setShowFieldMappingModal(false); setHighlightedSourceColumns([]); }} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Close</button></div>
                            </div>
                        </div>
                    )}
                    {showExampleModal && selectedNewField && (
                        <div className="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg shadow-xl p-6 w-[500px] max-w-full mx-4 max-h-[85vh] overflow-hidden flex flex-col">
                                <div className="flex justify-between items-start mb-4">
                                    <div><h3 className="text-lg font-bold">Field Example</h3><p className="text-sm text-gray-500 mt-1"><span className="font-mono bg-blue-100 px-2 py-1 rounded">{selectedNewField.name}</span> in <span className="font-semibold">{NEW_SCHEMA[selectedNewTable]?.displayName}</span></p></div>
                                    <button onClick={() => setShowExampleModal(false)} className="text-gray-500 hover:text-gray-700"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg></button>
                                </div>
                                <div className="bg-gray-100 rounded-lg p-4 mb-4">
                                    <div className="text-sm text-gray-600 mb-2"><strong>Data Type:</strong> {selectedNewField.type}</div>
                                </div>
                                {getExampleValue(selectedNewField.name) ? (
                                    <div className="bg-green-50 border border-green-200 rounded-lg p-4 flex-1 overflow-auto">
                                        <span className="font-semibold text-green-800">Example Value:</span>
                                        <pre className="mt-2 text-sm text-green-700 whitespace-pre-wrap break-all font-mono bg-green-100 p-3 rounded">{selectedNewField.type === 'JSONB' ? JSON.stringify(JSON.parse(getExampleValue(selectedNewField.name)), null, 2) : getExampleValue(selectedNewField.name)}</pre>
                                    </div>
                                ) : (
                                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                        <span className="text-yellow-800">No example available for this field.</span>
                                    </div>
                                )}
                                <div className="mt-4 pt-4 border-t flex justify-end"><button onClick={() => setShowExampleModal(false)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Close</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
