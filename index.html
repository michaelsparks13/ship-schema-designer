<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ship Database Schema Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fill-pct-bar { height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; }
        .fill-pct-bar-inner { height: 100%; border-radius: 2px; }
        .schema-table { transition: all 0.2s ease; }
        .schema-table:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .field-item { cursor: pointer; transition: all 0.15s ease; position: relative; }
        .field-item:hover { background-color: rgb(243 244 246); }
        .field-item.has-mapping:hover { background-color: rgb(219 234 254); }
        .source-column-highlight { animation: pulse-highlight 1.5s ease-in-out infinite; }
        @keyframes pulse-highlight { 0%, 100% { background-color: rgb(254 249 195); } 50% { background-color: rgb(253 224 71); } }
        .edit-btn { opacity: 0; transition: opacity 0.15s; }
        .field-item:hover .edit-btn, .table-header:hover .edit-btn { opacity: 1; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        .dragging { opacity: 0.5; }
        .drop-target { border: 2px dashed #3b82f6 !important; background-color: #eff6ff !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const FIELD_EXAMPLES = {
            'id': '12345', 'imo_number': '9134270', 'mmsi': '412345678', 'call_sign': 'BQKV',
            'national_registration_number': 'PE-01234-CM', 'external_marking': 'INKA 201',
            'ship_name': 'HAI FENG 823', 'ship_name_local': '海丰823',
            'previous_name': 'LIAN RUN 22', 'flag': 'China', 'port_of_registry': 'Zhoushan',
            'owner_name': 'Zhejiang Ocean Family Co Ltd', 'owner_address': '88 Haitian Road, Zhoushan, Zhejiang',
            'operator_name': 'Pingtan Marine Enterprise', 'operator_address': '18 Pingtan Road, Fuzhou, Fujian',
            'gear': 'Trawlers - Midwater', 'width_m': '13.5', 'length_m': '58.2',
            'gross_tonnage': '1,245', 'number_of_crew': '28', 'ship_status': 'Active',
            'ship_status_effective_date': '2024-01-15', 'iuu_combined_list_ship_link': 'https://iuu-vessels.org/ship/12345',
            'iuu_combined_list': 'true', 'scraper_notes': 'Ship data updated from WCPFC registry 2024-03',
            'sea_shepherd_arrest_info': 'Detained in Liberia Aug 2019 for illegal transshipment',
            'code': 'WCPFC', 'full_name': 'Western and Central Pacific Fisheries Commission',
            'body_type': 'RFMO', 'website_url': 'https://www.wcpfc.int/',
            'description': 'Primary source for ship identity verification',
            'ship_id': '12345 (FK to ships.id)', 'authorizing_body_id': '3 (FK to authorizing_bodies.id)',
            'authorization_number': 'VR-2024-CHN-0892', 'authorization_start_date': '2024-01-01',
            'authorization_end_date': '2024-12-31', 'ship_authorization_link': 'https://wcpfc.int/ship/VR-2024-CHN-0892',
            'registered_with_eu': 'true', 'date_source_info_last_updated': '2024-03-15', 'date_source_info_acquired': '2024-02-01',
            'identity_source_id': '2 (FK to identity_sources.id)', 'identity_confirmed_by_gfw': 'true',
            'listed_in_magicport': 'true', 'confirmation_date': '2024-01-20',
            'source_data': '{"gfw_ship_id": "CHN-FV-8823", "confidence_score": 0.95, "last_ais_position": {"lat": -12.45, "lon": -77.12}, "matched_fields": ["imo", "mmsi", "call_sign"]}',
            'notes': 'Identity confirmed via AIS correlation', 'organization_id': '5 (FK to iuu_organizations.id)',
            'iuu_listing_date': '2022-05-20', 'iuu_listing_reason': 'Fishing without valid license in ICCAT waters; failure to report catch',
            'delisting_date': '2023-08-15', 'is_currently_listed': 'false', 'name': 'Peru', 'region': 'South America',
            'country_id': '8 (FK to countries.id)', 'license_number': 'PE-2024-CM-0456',
            'license_valid_from': '2024-01-01', 'permit_expiration': '2024-12-31',
            'permit_status': 'VIGENTE', 'taxpayer_id': 'RUC-20123456789',
            'additional_data': '{"port_assignments": ["Callao", "Chimbote"], "ship_category": "Industrial", "authorized_species": ["Anchoveta", "Sardine"], "quota_mt": 2500}',
            'fmfo_country_id': '4 (FK to fmfo_countries.id)', 'is_listed': 'true', 'listing_year': '2024',
            'fos_registration_number': 'FOS-2024-0123', 'fos_certified_company': 'Ocean Fresh Seafood Co.',
            'fao_fishing_area_per_fos': 'Area 87 - Southeast Pacific', 'targeted_species_per_fos': 'Anchoveta (Engraulis ringens)',
            'fos_certificate_status': 'Valid', 'name_from_date': '2015-06-01', 'name_to_date': '2019-03-15',
            'source': 'IHS Markit historical records', 'arrest_date': '2019-08-22',
            'arresting_authority': 'Liberia Coast Guard', 'arrest_location': 'Monrovia, Liberia (6.3N, 10.8W)',
            'arrest_reason': 'Illegal transshipment at sea; fishing in restricted zone',
            'fao_global_record_link': 'https://fao.org/global-record/ship/12345'
        };

        const INITIAL_SCHEMA = {
            ships: { name: 'ships', displayName: 'Ships (Core)', type: 'core', description: 'Central table with 191K ship records', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'imo_number', type: 'VARCHAR(20)', sources: ['IMO Number'] },
                { name: 'mmsi', type: 'VARCHAR(15)', sources: ['MMSI'] }, { name: 'call_sign', type: 'VARCHAR(20)', sources: ['Call Sign'] },
                { name: 'national_registration_number', type: 'VARCHAR(50)', sources: ['National Registration Number'] },
                { name: 'external_marking', type: 'VARCHAR(100)', sources: ['External Marking'] },
                { name: 'ship_name', type: 'VARCHAR(255)', sources: ['Ship Name'] },
                { name: 'flag', type: 'VARCHAR(100)', sources: ['Flag'] },
                { name: 'port_of_registry', type: 'VARCHAR(255)', sources: ['Port of Registry'] },
                { name: 'owner_name', type: 'VARCHAR(255)', sources: ['Owner Name'] }, { name: 'owner_address', type: 'TEXT', sources: ['Owner Address'] },
                { name: 'operator_name', type: 'VARCHAR(255)', sources: ['Operator Name'] }, { name: 'operator_address', type: 'TEXT', sources: ['Operator Address'] },
                { name: 'gear', type: 'VARCHAR(255)', sources: ['Gear'] }, { name: 'width_m', type: 'DECIMAL(8,2)', sources: ['Width (m)'] },
                { name: 'length_m', type: 'DECIMAL(8,2)', sources: ['Length (m)'] }, { name: 'gross_tonnage', type: 'DECIMAL(10,2)', sources: ['Gross Tonnage'] },
                { name: 'number_of_crew', type: 'INTEGER', sources: ['Number of Crew'] },
                { name: 'fao_global_record_link', type: 'TEXT', sources: ['FAO Global Record Link'] },
                { name: 'iuu_combined_list_ship_link', type: 'TEXT', sources: ['IUU Combined List Ship Link'] },
                { name: 'scraper_notes', type: 'TEXT', sources: ['Scraper Notes'] }
            ]},
            authorizing_bodies: { name: 'authorizing_bodies', displayName: 'Authorizing Bodies (Lookup)', type: 'lookup', description: '14 records: RFMOs + EU + FAO', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'code', type: 'VARCHAR(20)', sources: [] },
                { name: 'full_name', type: 'VARCHAR(255)', sources: [] }, { name: 'body_type', type: 'VARCHAR(50)', sources: [] }, { name: 'website_url', type: 'TEXT', sources: [] }
            ]},
            ship_authorizations: { name: 'ship_authorizations', displayName: 'Ship Authorizations (Junction)', type: 'junction', description: 'Replaces 68 RFMO/EU/FAO columns', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'ship_id', type: 'INTEGER (FK)', sources: [] }, { name: 'authorizing_body_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'authorization_number', type: 'VARCHAR(100)', sources: ['Authorization Number for NEAFC', 'Authorization Number for IATTC', 'Authorization Number for IOTC', 'Authorization Number for WCPFC', 'Authorization Number for NPFC', 'Authorization Number for SPRFMO', 'Authorization Number for ICCAT', 'Authorization Number for CCAMLR', 'Authorization Number for GFCM', 'Authorization Number for SEAFO', 'Authorization Number for NAFO'] },
                { name: 'authorization_start_date', type: 'DATE', sources: ['Authorization Start Date for 11 RFMOs'] },
                { name: 'authorization_end_date', type: 'DATE', sources: ['Authorization End Date for 11 RFMOs'] },
                { name: 'ship_authorization_link', type: 'TEXT', sources: ['Ship Authorization Link for 13 sources'] },
                { name: 'registered_with_eu', type: 'BOOLEAN', sources: ['Registered with EU'] },
                { name: 'date_source_info_last_updated', type: 'DATE', sources: ['Date Source Info Last Updated (8 cols)'] },
                { name: 'date_source_info_acquired', type: 'DATE', sources: ['Date Source Info Acquired (7 cols)'] }
            ]},
            identity_sources: { name: 'identity_sources', displayName: 'Identity Sources (Lookup)', type: 'lookup', description: '3 records: MagicPort, GFW, IHS', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'code', type: 'VARCHAR(20)', sources: [] },
                { name: 'full_name', type: 'VARCHAR(255)', sources: [] }, { name: 'description', type: 'TEXT', sources: [] }
            ]},
            ship_identity_confirmations: { name: 'ship_identity_confirmations', displayName: 'Ship Identity Confirmations (Junction)', type: 'junction', description: 'Tracks identity verification sources', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'ship_id', type: 'INTEGER (FK)', sources: [] }, { name: 'identity_source_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'is_confirmed', type: 'BOOLEAN', sources: ['Listed in MagicPort', 'Identity Confirmed by Global Fishing Watch'] },
                { name: 'confirmation_date', type: 'DATE', sources: [] }, { name: 'source_data', type: 'JSONB', sources: [] }, { name: 'notes', type: 'TEXT', sources: [] }
            ]},
            iuu_organizations: { name: 'iuu_organizations', displayName: 'IUU Organizations (Lookup)', type: 'lookup', description: '13 organizations maintaining IUU lists', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'code', type: 'VARCHAR(20)', sources: [] }, { name: 'full_name', type: 'VARCHAR(255)', sources: [] }
            ]},
            ship_iuu_listings: { name: 'ship_iuu_listings', displayName: 'Ship IUU Listings (Junction)', type: 'junction', description: 'Replaces 24 IUU columns', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'ship_id', type: 'INTEGER (FK)', sources: [] }, { name: 'organization_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'iuu_listing_date', type: 'DATE', sources: ['IUU Listing Date for 12 orgs'] },
                { name: 'iuu_listing_reason', type: 'TEXT', sources: ['IUU Listing Reason for 12 orgs'] },
                { name: 'delisting_date', type: 'DATE', sources: [] }, { name: 'is_currently_listed', type: 'BOOLEAN', sources: [] }
            ]},
            countries: { name: 'countries', displayName: 'Countries (Lookup)', type: 'lookup', description: '15 countries with registries', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'code', type: 'VARCHAR(10)', sources: [] },
                { name: 'name', type: 'VARCHAR(255)', sources: [] }, { name: 'region', type: 'VARCHAR(100)', sources: [] }
            ]},
            ship_country_registrations: { name: 'ship_country_registrations', displayName: 'Ship Country Registrations (Junction)', type: 'junction', description: 'Replaces ~50 country columns', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'ship_id', type: 'INTEGER (FK)', sources: [] }, { name: 'country_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'is_registered', type: 'BOOLEAN', sources: [] },
                { name: 'license_number', type: 'VARCHAR(100)', sources: ['PERU License Number', 'THAI License Number', 'INDONESIA License'] },
                { name: 'license_valid_from', type: 'DATE', sources: [] },
                { name: 'permit_expiration', type: 'DATE', sources: ['PERU Permit Expiration', 'THAI Cert Expiration'] },
                { name: 'permit_status', type: 'VARCHAR(100)', sources: ['PERU Permit Status', 'THAI Permit Availability'] },
                { name: 'taxpayer_id', type: 'VARCHAR(100)', sources: ['PERU Taxpayer ID'] }, { name: 'additional_data', type: 'JSONB', sources: [] }
            ]},
            fmfo_countries: { name: 'fmfo_countries', displayName: 'FMFO Countries (Lookup)', type: 'lookup', description: '11 FMFO monitoring countries', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'code', type: 'VARCHAR(10)', sources: [] }, { name: 'name', type: 'VARCHAR(255)', sources: [] }
            ]},
            ship_fmfo_listings: { name: 'ship_fmfo_listings', displayName: 'Ship FMFO Listings (Junction)', type: 'junction', description: 'Replaces 11 FMFO boolean columns', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'ship_id', type: 'INTEGER (FK)', sources: [] }, { name: 'fmfo_country_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'is_listed', type: 'BOOLEAN', sources: ['Peru FMFO', 'India FMFO', 'Ecuador FMFO', 'Thailand FMFO', '+7 more'] },
                { name: 'listing_year', type: 'INTEGER', sources: [] }, { name: 'notes', type: 'TEXT', sources: [] }
            ]},
            friend_of_sea_certifications: { name: 'friend_of_sea_certifications', displayName: 'Friend of the Sea Certs', type: 'supporting', description: 'FOS certification data', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'ship_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'fos_registration_number', type: 'VARCHAR(100)', sources: ['Friend of the Sea Registration Number'] },
                { name: 'fos_certified_company', type: 'VARCHAR(255)', sources: ['Company authorized to sell FOS products'] },
                { name: 'fao_fishing_area_per_fos', type: 'VARCHAR(255)', sources: ['FAO fishing area per FOS'] },
                { name: 'targeted_species_per_fos', type: 'TEXT', sources: ['Targeted species per FOS'] },
                { name: 'fos_certificate_status', type: 'VARCHAR(50)', sources: ['FOS Certificate Status'] }
            ]},
            ship_name_history: { name: 'ship_name_history', displayName: 'Ship Name History', type: 'supporting', description: 'Historical names for compliance', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'ship_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'previous_name', type: 'VARCHAR(255)', sources: ['Previous Name'] },
                { name: 'name_from_date', type: 'DATE', sources: [] }, { name: 'name_to_date', type: 'DATE', sources: [] }, { name: 'source', type: 'VARCHAR(255)', sources: [] }
            ]},
            ship_arrests: { name: 'ship_arrests', displayName: 'Ship Arrests', type: 'supporting', description: 'Enforcement arrest records', fields: [
                { name: 'id', type: 'INTEGER (PK)', sources: [] }, { name: 'ship_id', type: 'INTEGER (FK)', sources: [] },
                { name: 'arrest_date', type: 'DATE', sources: [] }, { name: 'arresting_authority', type: 'VARCHAR(255)', sources: [] },
                { name: 'arrest_location', type: 'VARCHAR(255)', sources: [] }, { name: 'arrest_reason', type: 'TEXT', sources: ['Sea Shepherd Arrest Info'] }
            ]}
        };

        const TABLE_TYPES = ['core', 'lookup', 'junction', 'supporting'];

        function App() {
            const [loading, setLoading] = useState(true);
            const [loadingStatus, setLoadingStatus] = useState('Loading...');
            const [loadError, setLoadError] = useState(null);
            const [allColumns, setAllColumns] = useState([]);
            const [columnStats, setColumnStats] = useState({});
            const [totalRows, setTotalRows] = useState(0);
            const [searchFilter, setSearchFilter] = useState('');
            const [selectedNewField, setSelectedNewField] = useState(null);
            const [selectedNewTable, setSelectedNewTable] = useState(null);
            const [highlightedSourceColumns, setHighlightedSourceColumns] = useState([]);
            const [showFieldMappingModal, setShowFieldMappingModal] = useState(false);
            const [showExampleModal, setShowExampleModal] = useState(false);

            // Edit mode state
            const [editMode, setEditMode] = useState(false);
            const [schema, setSchema] = useState(INITIAL_SCHEMA);
            const [tableOrder, setTableOrder] = useState(Object.keys(INITIAL_SCHEMA));

            // Modal states for editing
            const [showEditTableModal, setShowEditTableModal] = useState(false);
            const [showAddTableModal, setShowAddTableModal] = useState(false);
            const [showEditFieldModal, setShowEditFieldModal] = useState(false);
            const [showMoveFieldModal, setShowMoveFieldModal] = useState(false);
            const [editingTable, setEditingTable] = useState(null);
            const [editingField, setEditingField] = useState(null);
            const [editingFieldIndex, setEditingFieldIndex] = useState(null);

            // Drag state
            const [draggedField, setDraggedField] = useState(null);
            const [draggedTable, setDraggedTable] = useState(null);
            const [dropTarget, setDropTarget] = useState(null);

            useEffect(() => { loadCSVData(); }, []);

            const loadCSVData = async () => {
                setLoading(true);
                try {
                    const sampleResults = await new Promise((resolve, reject) => {
                        Papa.parse('sample_data.csv', { download: true, header: true, skipEmptyLines: true, complete: resolve, error: reject });
                    });
                    const columns = (sampleResults.meta.fields || []).filter(c => c && c.trim() && c !== 'Unnamed: 0');
                    setAllColumns(columns);
                    setLoadingStatus('Calculating statistics...');
                    const stats = {}; let rowCount = 0;
                    columns.forEach(col => { stats[col] = { nonEmptyCount: 0, uniqueValues: new Set() }; });
                    await new Promise((resolve, reject) => {
                        Papa.parse('full_data.csv', { download: true, header: true, skipEmptyLines: true,
                            step: (row) => { rowCount++; columns.forEach(col => { const val = row.data[col]; if (val && val.trim()) { stats[col].nonEmptyCount++; if (stats[col].uniqueValues.size < 100) stats[col].uniqueValues.add(val.trim()); }}); if (rowCount % 5000 === 0) setLoadingStatus(`Row ${rowCount.toLocaleString()}...`); },
                            complete: resolve, error: reject });
                    });
                    const finalStats = {};
                    columns.forEach(col => { finalStats[col] = { fillPct: rowCount > 0 ? (stats[col].nonEmptyCount / rowCount * 100).toFixed(1) : 0, nonEmptyCount: stats[col].nonEmptyCount, uniqueValues: Array.from(stats[col].uniqueValues).sort() }; });
                    setColumnStats(finalStats); setTotalRows(rowCount); setLoading(false);
                } catch (error) { console.error(error); setLoadError('Failed to load data.'); setLoading(false); }
            };

            // Helper functions
            const getFillBarColor = (pct) => { const p = parseFloat(pct); if (p >= 80) return 'bg-green-500'; if (p >= 50) return 'bg-yellow-500'; if (p >= 20) return 'bg-orange-500'; return 'bg-red-500'; };
            const getTypeColor = (type) => { switch(type) { case 'core': return 'border-blue-500'; case 'lookup': return 'border-green-500'; case 'junction': return 'border-purple-500'; case 'supporting': return 'border-orange-500'; default: return 'border-gray-500'; } };
            const getTypeBadgeColor = (type) => { switch(type) { case 'core': return 'bg-blue-100 text-blue-800'; case 'lookup': return 'bg-green-100 text-green-800'; case 'junction': return 'bg-purple-100 text-purple-800'; case 'supporting': return 'bg-orange-100 text-orange-800'; default: return 'bg-gray-100 text-gray-800'; } };
            const getFilteredColumns = (columns) => { if (!searchFilter.trim()) return columns; const f = searchFilter.toLowerCase(); return columns.filter(col => col.toLowerCase().includes(f)); };
            const getExampleValue = (fieldName) => FIELD_EXAMPLES[fieldName] || null;

            // Field click handler
            const handleFieldClick = (tableName, field, fieldIndex) => {
                if (editMode) {
                    setEditingTable(tableName);
                    setEditingField({...field});
                    setEditingFieldIndex(fieldIndex);
                    setShowEditFieldModal(true);
                } else {
                    setSelectedNewTable(tableName);
                    setSelectedNewField(field);
                    if (field.sources?.length > 0) {
                        setHighlightedSourceColumns(field.sources);
                        setShowFieldMappingModal(true);
                    } else {
                        setShowExampleModal(true);
                    }
                }
            };

            // Schema editing functions
            const updateTableName = (oldKey, newName, newDisplayName, newType, newDescription) => {
                const newSchema = {...schema};
                const table = {...newSchema[oldKey]};
                table.name = newName;
                table.displayName = newDisplayName;
                table.type = newType;
                table.description = newDescription;

                if (oldKey !== newName) {
                    delete newSchema[oldKey];
                    newSchema[newName] = table;
                    setTableOrder(tableOrder.map(k => k === oldKey ? newName : k));
                } else {
                    newSchema[oldKey] = table;
                }
                setSchema(newSchema);
            };

            const deleteTable = (tableKey) => {
                if (confirm(`Delete table "${tableKey}"? This cannot be undone.`)) {
                    const newSchema = {...schema};
                    delete newSchema[tableKey];
                    setSchema(newSchema);
                    setTableOrder(tableOrder.filter(k => k !== tableKey));
                }
            };

            const addTable = (name, displayName, type, description) => {
                const newSchema = {...schema};
                newSchema[name] = {
                    name,
                    displayName,
                    type,
                    description,
                    fields: [{ name: 'id', type: 'INTEGER (PK)', sources: [] }]
                };
                setSchema(newSchema);
                setTableOrder([...tableOrder, name]);
            };

            const updateField = (tableKey, fieldIndex, newField) => {
                const newSchema = {...schema};
                newSchema[tableKey].fields[fieldIndex] = newField;
                setSchema(newSchema);
            };

            const deleteField = (tableKey, fieldIndex) => {
                const newSchema = {...schema};
                newSchema[tableKey].fields.splice(fieldIndex, 1);
                setSchema(newSchema);
            };

            const addField = (tableKey) => {
                const newSchema = {...schema};
                newSchema[tableKey].fields.push({ name: 'new_field', type: 'VARCHAR(255)', sources: [] });
                setSchema(newSchema);
            };

            const moveFieldUp = (tableKey, fieldIndex) => {
                if (fieldIndex === 0) return;
                const newSchema = {...schema};
                const fields = [...newSchema[tableKey].fields];
                [fields[fieldIndex - 1], fields[fieldIndex]] = [fields[fieldIndex], fields[fieldIndex - 1]];
                newSchema[tableKey].fields = fields;
                setSchema(newSchema);
            };

            const moveFieldDown = (tableKey, fieldIndex) => {
                const newSchema = {...schema};
                const fields = [...newSchema[tableKey].fields];
                if (fieldIndex >= fields.length - 1) return;
                [fields[fieldIndex], fields[fieldIndex + 1]] = [fields[fieldIndex + 1], fields[fieldIndex]];
                newSchema[tableKey].fields = fields;
                setSchema(newSchema);
            };

            const moveFieldToTable = (fromTable, fieldIndex, toTable) => {
                const newSchema = {...schema};
                const field = newSchema[fromTable].fields[fieldIndex];
                newSchema[fromTable].fields.splice(fieldIndex, 1);
                newSchema[toTable].fields.push(field);
                setSchema(newSchema);
            };

            const moveTableUp = (tableKey) => {
                const idx = tableOrder.indexOf(tableKey);
                if (idx <= 0) return;
                const newOrder = [...tableOrder];
                [newOrder[idx - 1], newOrder[idx]] = [newOrder[idx], newOrder[idx - 1]];
                setTableOrder(newOrder);
            };

            const moveTableDown = (tableKey) => {
                const idx = tableOrder.indexOf(tableKey);
                if (idx >= tableOrder.length - 1) return;
                const newOrder = [...tableOrder];
                [newOrder[idx], newOrder[idx + 1]] = [newOrder[idx + 1], newOrder[idx]];
                setTableOrder(newOrder);
            };

            // Map our types to Directus/Postgres types
            const mapTypeToDirectus = (type) => {
                const t = type.toLowerCase();
                if (t.includes('(pk)')) return { type: 'integer', dataType: 'integer', isPrimary: true, hasAutoIncrement: true };
                if (t.includes('(fk)')) return { type: 'integer', dataType: 'integer', isPrimary: false, hasAutoIncrement: false };
                if (t.includes('integer')) return { type: 'integer', dataType: 'integer', isPrimary: false, hasAutoIncrement: false };
                if (t.includes('boolean')) return { type: 'boolean', dataType: 'boolean', isPrimary: false, hasAutoIncrement: false };
                if (t.includes('decimal')) return { type: 'decimal', dataType: 'numeric', isPrimary: false, hasAutoIncrement: false };
                if (t.includes('date')) return { type: 'date', dataType: 'date', isPrimary: false, hasAutoIncrement: false };
                if (t.includes('jsonb')) return { type: 'json', dataType: 'jsonb', isPrimary: false, hasAutoIncrement: false };
                if (t.includes('text')) return { type: 'text', dataType: 'text', isPrimary: false, hasAutoIncrement: false };
                // Default VARCHAR
                const match = t.match(/varchar\((\d+)\)/);
                const length = match ? parseInt(match[1]) : 255;
                return { type: 'string', dataType: 'character varying', maxLength: length, isPrimary: false, hasAutoIncrement: false };
            };

            const exportSchema = (format = 'simple') => {
                if (format === 'simple') {
                    const orderedSchema = {};
                    tableOrder.forEach(key => { if (schema[key]) orderedSchema[key] = schema[key]; });
                    const blob = new Blob([JSON.stringify(orderedSchema, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'ship_schema.json';
                    a.click();
                    URL.revokeObjectURL(url);
                } else if (format === 'directus') {
                    // Build Directus-compatible schema snapshot
                    const collections = [];
                    const fields = [];
                    const relations = [];

                    tableOrder.forEach((tableKey, tableIndex) => {
                        const table = schema[tableKey];
                        if (!table) return;

                        // Add collection
                        collections.push({
                            collection: table.name,
                            meta: {
                                accountability: 'all',
                                archive_app_filter: true,
                                archive_field: null,
                                collapse: 'open',
                                color: null,
                                display_template: null,
                                group: null,
                                hidden: false,
                                icon: table.type === 'core' ? 'anchor' : table.type === 'lookup' ? 'book' : table.type === 'junction' ? 'link' : 'folder',
                                item_duplication_fields: null,
                                note: table.description,
                                preview_url: null,
                                singleton: false,
                                sort: tableIndex + 1,
                                sort_field: null,
                                translations: null,
                                versioning: false
                            },
                            schema: { name: table.name }
                        });

                        // Add fields
                        table.fields.forEach((field, fieldIndex) => {
                            const typeInfo = mapTypeToDirectus(field.type);
                            const fieldDef = {
                                collection: table.name,
                                field: field.name,
                                type: typeInfo.type,
                                meta: {
                                    collection: table.name,
                                    conditions: null,
                                    display: null,
                                    display_options: null,
                                    field: field.name,
                                    group: null,
                                    hidden: typeInfo.isPrimary,
                                    interface: typeInfo.type === 'boolean' ? 'boolean' : typeInfo.type === 'json' ? 'input-code' : typeInfo.type === 'text' ? 'input-multiline' : typeInfo.type === 'date' ? 'datetime' : 'input',
                                    note: field.sources?.length ? `Replaces: ${field.sources.join(', ')}` : null,
                                    options: typeInfo.type === 'json' ? { language: 'json' } : null,
                                    readonly: typeInfo.isPrimary,
                                    required: typeInfo.isPrimary,
                                    sort: fieldIndex + 1,
                                    special: typeInfo.type === 'json' ? ['cast-json'] : null,
                                    translations: null,
                                    validation: null,
                                    validation_message: null,
                                    width: 'full'
                                },
                                schema: {
                                    name: field.name,
                                    table: table.name,
                                    data_type: typeInfo.dataType,
                                    default_value: null,
                                    max_length: typeInfo.maxLength || null,
                                    numeric_precision: typeInfo.dataType === 'numeric' ? 10 : null,
                                    numeric_scale: typeInfo.dataType === 'numeric' ? 2 : null,
                                    is_nullable: !typeInfo.isPrimary,
                                    is_unique: typeInfo.isPrimary,
                                    is_primary_key: typeInfo.isPrimary,
                                    has_auto_increment: typeInfo.hasAutoIncrement,
                                    foreign_key_column: null,
                                    foreign_key_table: null
                                }
                            };
                            fields.push(fieldDef);

                            // Add relations for FK fields
                            if (field.type.includes('(FK)') && field.name.endsWith('_id')) {
                                const relatedTable = field.name.replace('_id', '') + 's'; // Simple pluralization
                                // Try to find actual table name
                                const actualTable = tableOrder.find(t =>
                                    t === relatedTable ||
                                    t === field.name.replace('_id', '') ||
                                    schema[t]?.name === relatedTable ||
                                    schema[t]?.name === field.name.replace('_id', '')
                                );
                                if (actualTable) {
                                    relations.push({
                                        collection: table.name,
                                        field: field.name,
                                        related_collection: schema[actualTable]?.name || actualTable,
                                        meta: {
                                            many_collection: table.name,
                                            many_field: field.name,
                                            one_collection: schema[actualTable]?.name || actualTable,
                                            one_field: null,
                                            one_collection_field: null,
                                            one_allowed_collections: null,
                                            junction_field: null,
                                            sort_field: null,
                                            one_deselect_action: 'nullify'
                                        },
                                        schema: {
                                            table: table.name,
                                            column: field.name,
                                            foreign_key_table: schema[actualTable]?.name || actualTable,
                                            foreign_key_column: 'id',
                                            on_update: 'NO ACTION',
                                            on_delete: 'SET NULL'
                                        }
                                    });
                                }
                            }
                        });
                    });

                    const directusSnapshot = {
                        version: 1,
                        directus: '10.0.0',
                        vendor: 'postgres',
                        collections,
                        fields,
                        relations
                    };

                    const blob = new Blob([JSON.stringify(directusSnapshot, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'ship_schema_directus.json';
                    a.click();
                    URL.revokeObjectURL(url);
                }
            };

            const [showExportModal, setShowExportModal] = useState(false);

            const resetSchema = () => {
                if (confirm('Reset schema to original? All changes will be lost.')) {
                    setSchema(INITIAL_SCHEMA);
                    setTableOrder(Object.keys(INITIAL_SCHEMA));
                }
            };

            if (loading) return <div className="min-h-screen bg-gray-100 flex items-center justify-center"><div className="text-center"><div className="loading-spinner mx-auto mb-4"></div><p className="text-gray-600">{loadingStatus}</p></div></div>;
            if (loadError) return <div className="min-h-screen bg-gray-100 flex items-center justify-center"><div className="bg-white rounded-lg shadow-lg p-8 max-w-md text-center"><h2 className="text-xl font-bold mb-2">Error</h2><p className="text-gray-600 mb-4">{loadError}</p><button onClick={loadCSVData} className="px-4 py-2 bg-blue-600 text-white rounded-lg">Retry</button></div></div>;

            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-white shadow-sm border-b sticky top-0 z-40">
                        <div className="max-w-full mx-auto px-4 py-4 flex justify-between items-center">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-900">Ship Database Schema Designer</h1>
                                <p className="text-sm text-gray-500 mt-1">144 fields | 183,000 rows</p>
                                <div className="flex gap-4 mt-2">
                                    <a href="team_share_data.csv" download className="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                        Download Sample Data (1,000 rows)
                                    </a>
                                    <a href="https://github.com/michaelsparks13/ship-schema-designer" target="_blank" rel="noopener noreferrer" className="text-sm text-gray-600 hover:text-gray-800 flex items-center gap-1">
                                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                                        Fork on GitHub
                                    </a>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                {editMode && (
                                    <>
                                        <button onClick={() => setShowAddTableModal(true)} className="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm flex items-center gap-1">
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                                            Add Table
                                        </button>
                                        <button onClick={() => setShowExportModal(true)} className="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm flex items-center gap-1">
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                            Export
                                        </button>
                                        <button onClick={resetSchema} className="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm">Reset</button>
                                    </>
                                )}
                                <button onClick={() => setEditMode(!editMode)} className={`px-4 py-2 rounded-lg text-sm font-medium ${editMode ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                                    {editMode ? 'Exit Edit Mode' : 'Edit Schema'}
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-full mx-auto px-4 py-6">
                        {editMode && (
                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                                <p className="text-yellow-800 font-medium">Edit Mode Active</p>
                                <p className="text-yellow-700 text-sm mt-1">Click on tables or fields to edit. Use arrows to reorder. Changes are saved in browser memory until you export.</p>
                            </div>
                        )}

                        <div className="bg-white rounded-lg shadow p-6 mb-6">
                            <h2 className="text-xl font-bold mb-4">Schema Transformation Summary</h2>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="text-center p-4 bg-red-50 rounded-lg border border-red-200"><div className="text-3xl font-bold text-red-600">144</div><div className="text-sm text-red-700">Current Fields</div></div>
                                <div className="text-center p-4 bg-green-50 rounded-lg border border-green-200"><div className="text-3xl font-bold text-green-600">{tableOrder.length}</div><div className="text-sm text-green-700">New Tables</div></div>
                                <div className="text-center p-4 bg-blue-50 rounded-lg border border-blue-200"><div className="text-3xl font-bold text-blue-600">{tableOrder.reduce((sum, k) => sum + (schema[k]?.fields.length || 0), 0)}</div><div className="text-sm text-blue-700">New Fields</div></div>
                                <div className="text-center p-4 bg-purple-50 rounded-lg border border-purple-200"><div className="text-3xl font-bold text-purple-600">51%</div><div className="text-sm text-purple-700">Reduction</div></div>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow p-4 mb-6">
                            <h3 className="font-semibold mb-3">Table Types</h3>
                            <div className="flex flex-wrap gap-4">
                                <div className="flex items-center gap-2"><div className="w-4 h-4 rounded border-2 border-blue-500 bg-blue-50"></div><span className="text-sm">Core</span></div>
                                <div className="flex items-center gap-2"><div className="w-4 h-4 rounded border-2 border-green-500 bg-green-50"></div><span className="text-sm">Lookup</span></div>
                                <div className="flex items-center gap-2"><div className="w-4 h-4 rounded border-2 border-purple-500 bg-purple-50"></div><span className="text-sm">Junction</span></div>
                                <div className="flex items-center gap-2"><div className="w-4 h-4 rounded border-2 border-orange-500 bg-orange-50"></div><span className="text-sm">Supporting</span></div>
                                <div className="flex items-center gap-2 ml-8"><div className="w-4 h-4 rounded bg-blue-100"></div><span className="text-sm">{editMode ? 'Click to edit' : 'Click for example'}</span></div>
                            </div>
                        </div>

                        <div className="mb-8">
                            <h2 className="text-xl font-bold mb-4"><span className="text-green-600">NEW</span> Relational Schema ({tableOrder.length} Tables)</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                {tableOrder.map((tableName, tableIndex) => {
                                    const table = schema[tableName];
                                    if (!table) return null;
                                    return (
                                        <div key={tableName} className={`schema-table bg-white rounded-lg shadow border-l-4 ${getTypeColor(table.type)}`}>
                                            <div className="table-header p-4 border-b bg-gray-50">
                                                <div className="flex items-center justify-between">
                                                    <h3 className="font-bold text-gray-900 truncate flex-1">{table.name}</h3>
                                                    <div className="flex items-center gap-1">
                                                        {editMode && (
                                                            <>
                                                                <button onClick={() => moveTableUp(tableName)} className="edit-btn p-1 text-gray-400 hover:text-gray-600" title="Move up">
                                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg>
                                                                </button>
                                                                <button onClick={() => moveTableDown(tableName)} className="edit-btn p-1 text-gray-400 hover:text-gray-600" title="Move down">
                                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                                                </button>
                                                                <button onClick={() => { setEditingTable(tableName); setShowEditTableModal(true); }} className="edit-btn p-1 text-blue-500 hover:text-blue-700" title="Edit table">
                                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                                </button>
                                                                <button onClick={() => deleteTable(tableName)} className="edit-btn p-1 text-red-500 hover:text-red-700" title="Delete table">
                                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                                </button>
                                                            </>
                                                        )}
                                                        <span className={`text-xs px-2 py-1 rounded ml-1 ${getTypeBadgeColor(table.type)}`}>{table.type}</span>
                                                    </div>
                                                </div>
                                                <p className="text-xs text-gray-500 mt-1">{table.description}</p>
                                            </div>
                                            <div className="p-2 max-h-[300px] overflow-y-auto">
                                                {table.fields.map((field, idx) => {
                                                    const hasMapping = field.sources?.length > 0;
                                                    const example = getExampleValue(field.name);
                                                    return (
                                                        <div key={idx} onClick={() => handleFieldClick(tableName, field, idx)} className={`field-item p-2 rounded text-sm border mb-1 ${hasMapping ? 'bg-blue-50 border-blue-200 has-mapping' : example ? 'bg-gray-50 border-gray-200' : 'bg-gray-50 border-gray-200'}`}>
                                                            <div className="flex justify-between items-start">
                                                                <span className="font-medium text-gray-800 flex-1 truncate">{field.name}</span>
                                                                <div className="flex items-center gap-1">
                                                                    {editMode && (
                                                                        <>
                                                                            <button onClick={(e) => { e.stopPropagation(); moveFieldUp(tableName, idx); }} className="edit-btn p-0.5 text-gray-400 hover:text-gray-600">
                                                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg>
                                                                            </button>
                                                                            <button onClick={(e) => { e.stopPropagation(); moveFieldDown(tableName, idx); }} className="edit-btn p-0.5 text-gray-400 hover:text-gray-600">
                                                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                                                            </button>
                                                                            <button onClick={(e) => { e.stopPropagation(); setEditingTable(tableName); setEditingField(field); setEditingFieldIndex(idx); setShowMoveFieldModal(true); }} className="edit-btn p-0.5 text-purple-500 hover:text-purple-700" title="Move to table">
                                                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                                                                            </button>
                                                                            <button onClick={(e) => { e.stopPropagation(); if(confirm('Delete field?')) deleteField(tableName, idx); }} className="edit-btn p-0.5 text-red-500 hover:text-red-700">
                                                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                                                            </button>
                                                                        </>
                                                                    )}
                                                                    <span className="text-xs text-gray-500 ml-1">{field.type}</span>
                                                                </div>
                                                            </div>
                                                            {!editMode && hasMapping && <div className="text-xs text-blue-600 mt-1">Replaces {field.sources.length} column{field.sources.length > 1 ? 's' : ''}</div>}
                                                            {!editMode && !hasMapping && example && <div className="text-xs text-gray-500 mt-1">Click for example</div>}
                                                        </div>
                                                    );
                                                })}
                                                {editMode && (
                                                    <button onClick={() => addField(tableName)} className="w-full p-2 border-2 border-dashed border-gray-300 rounded text-sm text-gray-500 hover:border-blue-400 hover:text-blue-600 mt-1">
                                                        + Add Field
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        <details className="bg-white rounded-lg shadow mb-6">
                            <summary className="p-4 cursor-pointer font-bold text-lg flex items-center justify-between"><span><span className="text-red-600">CURRENT</span> Flat Structure (144 Fields)</span><span className="text-sm font-normal text-gray-500">Click to expand</span></summary>
                            <div className="p-4 border-t">
                                <input type="text" placeholder="Search columns..." value={searchFilter} onChange={(e) => setSearchFilter(e.target.value)} className="w-full max-w-md px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 mb-4" />
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 max-h-[500px] overflow-y-auto">
                                    {getFilteredColumns(allColumns).map(col => { const isHighlighted = highlightedSourceColumns.includes(col); const fillPct = columnStats[col]?.fillPct || 0;
                                        return (<div key={col} className={`p-2 rounded border text-xs ${isHighlighted ? 'source-column-highlight border-yellow-400' : 'bg-white border-gray-200'}`} title={`${col}\n${fillPct}%`}>
                                            <div className="truncate font-medium">{col}</div>
                                            <div className="flex items-center gap-1 mt-1"><div className="fill-pct-bar flex-1"><div className={`fill-pct-bar-inner ${getFillBarColor(fillPct)}`} style={{ width: `${fillPct}%` }} /></div><span className="text-gray-500">{fillPct}%</span></div>
                                        </div>); })}
                                </div>
                            </div>
                        </details>
                    </div>

                    {/* Field Mapping Modal (view mode) */}
                    {showFieldMappingModal && selectedNewField && (
                        <div className="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg shadow-xl p-6 w-[700px] max-w-full mx-4 max-h-[85vh] overflow-hidden flex flex-col">
                                <div className="flex justify-between items-start mb-4">
                                    <div><h3 className="text-lg font-bold">Field Mapping</h3><p className="text-sm text-gray-500 mt-1"><span className="font-mono bg-blue-100 px-2 py-1 rounded">{selectedNewField.name}</span> in <span className="font-semibold">{schema[selectedNewTable]?.displayName}</span></p></div>
                                    <button onClick={() => { setShowFieldMappingModal(false); setHighlightedSourceColumns([]); }} className="text-gray-500 hover:text-gray-700"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg></button>
                                </div>
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                    <span className="font-semibold text-blue-800">Replaces {selectedNewField.sources.length} column{selectedNewField.sources.length > 1 ? 's' : ''}</span>
                                    <p className="text-sm text-blue-700 mt-2">Instead of separate columns, this field stores all values with organization identified via FK.</p>
                                </div>
                                {getExampleValue(selectedNewField.name) && (
                                    <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                        <span className="font-semibold text-green-800">Example Value:</span>
                                        <pre className="mt-2 text-sm text-green-700 whitespace-pre-wrap break-all font-mono bg-green-100 p-2 rounded">{getExampleValue(selectedNewField.name)}</pre>
                                    </div>
                                )}
                                <div className="flex-1 overflow-y-auto"><h4 className="font-semibold mb-2 text-gray-700">Source Columns:</h4><div className="space-y-2">
                                    {selectedNewField.sources.map((source, idx) => { const stats = columnStats[source]; return (
                                        <div key={idx} className="p-3 rounded border bg-gray-50 border-gray-200"><span className="text-sm font-medium">{source}</span>
                                            {stats && <div className="mt-2 flex items-center gap-2"><div className="fill-pct-bar flex-1 max-w-[200px]"><div className={`fill-pct-bar-inner ${getFillBarColor(stats.fillPct)}`} style={{ width: `${stats.fillPct}%` }} /></div><span className="text-xs text-gray-500">{stats.fillPct}% ({stats.nonEmptyCount?.toLocaleString() || 0})</span></div>}
                                        </div>); })}
                                </div></div>
                                <div className="mt-4 pt-4 border-t flex justify-end"><button onClick={() => { setShowFieldMappingModal(false); setHighlightedSourceColumns([]); }} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Close</button></div>
                            </div>
                        </div>
                    )}

                    {/* Example Modal (view mode) */}
                    {showExampleModal && selectedNewField && (
                        <div className="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg shadow-xl p-6 w-[500px] max-w-full mx-4 max-h-[85vh] overflow-hidden flex flex-col">
                                <div className="flex justify-between items-start mb-4">
                                    <div><h3 className="text-lg font-bold">Field Example</h3><p className="text-sm text-gray-500 mt-1"><span className="font-mono bg-blue-100 px-2 py-1 rounded">{selectedNewField.name}</span> in <span className="font-semibold">{schema[selectedNewTable]?.displayName}</span></p></div>
                                    <button onClick={() => setShowExampleModal(false)} className="text-gray-500 hover:text-gray-700"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg></button>
                                </div>
                                <div className="bg-gray-100 rounded-lg p-4 mb-4">
                                    <div className="text-sm text-gray-600 mb-2"><strong>Data Type:</strong> {selectedNewField.type}</div>
                                </div>
                                {getExampleValue(selectedNewField.name) ? (
                                    <div className="bg-green-50 border border-green-200 rounded-lg p-4 flex-1 overflow-auto">
                                        <span className="font-semibold text-green-800">Example Value:</span>
                                        <pre className="mt-2 text-sm text-green-700 whitespace-pre-wrap break-all font-mono bg-green-100 p-3 rounded">{selectedNewField.type === 'JSONB' ? JSON.stringify(JSON.parse(getExampleValue(selectedNewField.name)), null, 2) : getExampleValue(selectedNewField.name)}</pre>
                                    </div>
                                ) : (
                                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                        <span className="text-yellow-800">No example available for this field.</span>
                                    </div>
                                )}
                                <div className="mt-4 pt-4 border-t flex justify-end"><button onClick={() => setShowExampleModal(false)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Close</button></div>
                            </div>
                        </div>
                    )}

                    {/* Edit Table Modal */}
                    {showEditTableModal && editingTable && (
                        <div className="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg shadow-xl p-6 w-[500px] max-w-full mx-4">
                                <h3 className="text-lg font-bold mb-4">Edit Table</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Table Name (snake_case)</label>
                                        <input type="text" id="edit-table-name" defaultValue={schema[editingTable]?.name} className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                                        <input type="text" id="edit-table-display" defaultValue={schema[editingTable]?.displayName} className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Table Type</label>
                                        <select id="edit-table-type" defaultValue={schema[editingTable]?.type} className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                            {TABLE_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                        <input type="text" id="edit-table-desc" defaultValue={schema[editingTable]?.description} className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                </div>
                                <div className="mt-6 flex justify-end gap-3">
                                    <button onClick={() => setShowEditTableModal(false)} className="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                                    <button onClick={() => {
                                        const name = document.getElementById('edit-table-name').value.trim();
                                        const display = document.getElementById('edit-table-display').value.trim();
                                        const type = document.getElementById('edit-table-type').value;
                                        const desc = document.getElementById('edit-table-desc').value.trim();
                                        if (name) {
                                            updateTableName(editingTable, name, display, type, desc);
                                            setShowEditTableModal(false);
                                        }
                                    }} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Add Table Modal */}
                    {showAddTableModal && (
                        <div className="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg shadow-xl p-6 w-[500px] max-w-full mx-4">
                                <h3 className="text-lg font-bold mb-4">Add New Table</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Table Name (snake_case)</label>
                                        <input type="text" id="add-table-name" placeholder="new_table" className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                                        <input type="text" id="add-table-display" placeholder="New Table (Type)" className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Table Type</label>
                                        <select id="add-table-type" defaultValue="supporting" className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                            {TABLE_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                        <input type="text" id="add-table-desc" placeholder="Description of the table" className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                </div>
                                <div className="mt-6 flex justify-end gap-3">
                                    <button onClick={() => setShowAddTableModal(false)} className="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                                    <button onClick={() => {
                                        const name = document.getElementById('add-table-name').value.trim();
                                        const display = document.getElementById('add-table-display').value.trim();
                                        const type = document.getElementById('add-table-type').value;
                                        const desc = document.getElementById('add-table-desc').value.trim();
                                        if (name && !schema[name]) {
                                            addTable(name, display || name, type, desc);
                                            setShowAddTableModal(false);
                                        } else if (schema[name]) {
                                            alert('Table name already exists');
                                        }
                                    }} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Add Table</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Field Modal */}
                    {showEditFieldModal && editingField && (
                        <div className="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg shadow-xl p-6 w-[500px] max-w-full mx-4">
                                <h3 className="text-lg font-bold mb-4">Edit Field</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Field Name</label>
                                        <input type="text" id="edit-field-name" defaultValue={editingField.name} className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Data Type</label>
                                        <input type="text" id="edit-field-type" defaultValue={editingField.type} className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                </div>
                                <div className="mt-6 flex justify-end gap-3">
                                    <button onClick={() => setShowEditFieldModal(false)} className="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                                    <button onClick={() => {
                                        const name = document.getElementById('edit-field-name').value.trim();
                                        const type = document.getElementById('edit-field-type').value.trim();
                                        if (name && type) {
                                            updateField(editingTable, editingFieldIndex, {...editingField, name, type});
                                            setShowEditFieldModal(false);
                                        }
                                    }} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Move Field Modal */}
                    {showMoveFieldModal && editingField && (
                        <div className="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg shadow-xl p-6 w-[400px] max-w-full mx-4">
                                <h3 className="text-lg font-bold mb-4">Move Field to Table</h3>
                                <p className="text-sm text-gray-600 mb-4">Moving: <span className="font-mono bg-gray-100 px-2 py-1 rounded">{editingField.name}</span></p>
                                <div className="space-y-2 max-h-[300px] overflow-y-auto">
                                    {tableOrder.filter(t => t !== editingTable).map(t => (
                                        <button key={t} onClick={() => {
                                            moveFieldToTable(editingTable, editingFieldIndex, t);
                                            setShowMoveFieldModal(false);
                                        }} className="w-full text-left p-3 rounded border hover:bg-blue-50 hover:border-blue-300">
                                            <span className="font-medium">{schema[t]?.name}</span>
                                            <span className={`text-xs ml-2 px-2 py-0.5 rounded ${getTypeBadgeColor(schema[t]?.type)}`}>{schema[t]?.type}</span>
                                        </button>
                                    ))}
                                </div>
                                <div className="mt-4 flex justify-end">
                                    <button onClick={() => setShowMoveFieldModal(false)} className="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Export Modal */}
                    {showExportModal && (
                        <div className="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg shadow-xl p-6 w-[500px] max-w-full mx-4">
                                <h3 className="text-lg font-bold mb-4">Export Schema</h3>
                                <p className="text-sm text-gray-600 mb-4">Choose an export format:</p>
                                <div className="space-y-3">
                                    <button onClick={() => { exportSchema('simple'); setShowExportModal(false); }} className="w-full text-left p-4 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 transition-colors">
                                        <div className="font-semibold text-gray-900">Simple JSON</div>
                                        <div className="text-sm text-gray-500 mt-1">Human-readable format for documentation and review</div>
                                    </button>
                                    <button onClick={() => { exportSchema('directus'); setShowExportModal(false); }} className="w-full text-left p-4 rounded-lg border-2 border-gray-200 hover:border-purple-400 hover:bg-purple-50 transition-colors">
                                        <div className="font-semibold text-gray-900 flex items-center gap-2">
                                            Directus Schema Snapshot
                                            <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded">Recommended</span>
                                        </div>
                                        <div className="text-sm text-gray-500 mt-1">Compatible with <code className="bg-gray-100 px-1 rounded">npx directus schema apply</code></div>
                                        <div className="text-xs text-gray-400 mt-1">Includes collections, fields, relations, and meta settings</div>
                                    </button>
                                </div>
                                <div className="mt-4 pt-4 border-t">
                                    <div className="text-xs text-gray-500">
                                        <strong>To use with Directus:</strong>
                                        <ol className="list-decimal ml-4 mt-1 space-y-1">
                                            <li>Export as Directus Schema Snapshot</li>
                                            <li>POST to <code className="bg-gray-100 px-1 rounded">/schema/diff</code> to preview changes</li>
                                            <li>POST to <code className="bg-gray-100 px-1 rounded">/schema/apply</code> to apply</li>
                                        </ol>
                                    </div>
                                </div>
                                <div className="mt-4 flex justify-end">
                                    <button onClick={() => setShowExportModal(false)} className="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
